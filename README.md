# Телекоммуникационная биллинговая система "Ромашка"

## Обзор проекта

Проект представляет собой распределенную микросервисную систему биллинга для телекоммуникационной компании "Ромашка". Система обрабатывает данные о вызовах абонентов, тарифицирует их согласно тарифным планам и производит расчеты.

## Архитектура системы

Система построена на основе микросервисной архитектуры с использованием Spring Cloud и следует принципам:
- Независимое масштабирование сервисов
- Изоляция ответственности
- Асинхронная коммуникация через RabbitMQ
- Централизованная конфигурация (Spring Cloud Config)
- Сервисное обнаружение (Eureka)

### Основные компоненты

## Основные сервисы

### CDR-сервис 

CDR-сервис отвечает за генерацию и управление данными о вызовах абонентов:
- Генерирует исторические и новые записи о звонках
- Сохраняет CDR в базе данных
- Отправляет пакеты CDR в BRT-сервис через RabbitMQ

[Подробнее о CDR-сервисе](services/CDRService/README.md)

### BRT-сервис 

BRT-сервис выполняет обработку вызовов в реальном времени:
- Получает CDR от CDR-сервиса
- Фильтрует и обрабатывает записи для тарификации
- Взаимодействует с HRS-сервисом для тарификации
- Управляет балансами абонентов

[Подробнее о BRT-сервисе](services/BRTService/README.md)

### HRS-сервис 

HRS-сервис отвечает за тарификацию и расчет стоимости услуг:
- Применяет правила тарификации согласно тарифным планам
- Управляет пакетами услуг и их лимитами
- Формирует счета для абонентов
- Отслеживает циклы тарификации

[Подробнее о HRS-сервисе](services/HRSService/README.md)

### CRM-сервис

CRM-сервис предоставляет интерфейсы для взаимодействия абонентов и менеджеров с системой:
- Обеспечивает интерфейсы для управления абонентами менеджерами
- Предоставляет API для самообслуживания абонентов
- Реализует разграничение доступа по ролям
- Перенаправляет запросы в соответствующие сервисы системы

[Подробнее о CRM-сервисе](services/CRMService/README.md)

### SSO-сервис

SSO-сервис отвечает за аутентификацию и авторизацию пользователей:
- Осуществляет аутентификацию пользователей различных ролей
- Выпускает и проверяет JWT-токены
- Создает учетные записи для абонентов
- Обеспечивает централизованное управление безопасностью системы

[Подробнее о SSO-сервисе](services/SSOService/README.md)

### Инфраструктурные сервисы

- **Config Server** - централизованное управление конфигурациями
- **Eureka Server** - сервис обнаружения и регистрации микросервисов
- **API Gateway** - единая точка входа для внешних запросов

## Начало работы

### Клонирование репозитория

```bash
git clone --recurse-submodules https://github.com/is6769/Nexign-Bootcamp.git
cd Nexign-Bootcamp
```

### Запуск через Docker Compose

1. Убедитесь, что у вас установлены Docker и Docker Compose
2. Выполните сборку и запуск всех сервисов:

```bash
# Запустить все контейнеры
docker-compose up -d
```

### Ручной запуск

Для корректной работы системы необходимо запускать сервисы в определенном порядке, дожидаясь полной инициализации каждого сервиса перед запуском следующего.

#### Предварительные требования

- IntelliJ IDEA 2023.2 или новее с установленными плагинами Spring Boot
- Java 17 JDK
- PostgreSQL на портах с пользователем `postgres` и паролем `postgres`:
  - 5432 (для BRT-сервиса): `jdbc:postgresql://localhost:5432/brt-db`
  - 5433 (для HRS-сервиса): `jdbc:postgresql://localhost:5433/hrs-db`
  - 5434 (для SSO-сервиса): `jdbc:postgresql://localhost:5434/sso-db`
- RabbitMQ на порту 5672 с пользователем `admin` и паролем `admin`

#### Порядок запуска сервисов

1. **Config Server**
   - Запустите класс `ConfigServerApplication` с профилем `dev`
   - Дождитесь сообщения в консоли: `Completed initialization in X ms`
   - Убедитесь, что сервер запущен, открыв http://localhost:8888/actuator/health
   - **Важно**: Дождитесь полной инициализации (30-60 секунд)

2. **Eureka Server**
   - Запустите класс `EurekaServerApplication` с профилем `dev`
   - Дождитесь сообщения: `Started EurekaServerApplication in X seconds`
   - Проверьте доступность веб-интерфейса Eureka: http://localhost:8761
   - **Важно**: Дождитесь полной инициализации (30 секунд)

3. **HRS Service**
   - Запустите класс `HrsServiceApplication` с профилем `dev`
   - Дождитесь регистрации сервиса в Eureka 
   - Проверьте статус сервиса: http://localhost:8084/actuator/health
   - **Важно**: Перед запуском следующего сервиса убедитесь, что поле `status` имеет значение `UP`

4. **BRT Service**
   - Запустите класс `BrtServiceApplication` с профилем `dev`
   - Дождитесь регистрации сервиса в Eureka
   - Проверьте статус сервиса: http://localhost:8081/actuator/health
   - **Важно**: BRT-сервис должен запускаться после HRS сервисов
   - **Важно**: Убедитесь, что показатель `eurekaRegistration` имеет статус `UP`

5. **CDR Service**
   - Запустите класс `CdrServiceApplication` с профилем `dev`
   - Дождитесь завершения инициализации базы данных H2
   - Проверьте статус сервиса: http://localhost:8082/actuator/health

6. **SSO Service**
   - Запустите класс `SsoServiceApplication` с профилем `dev`
   - Дождитесь регистрации сервиса в Eureka
   - Убедитесь, что сервис создал учетную запись менеджера
   - Проверьте статус сервиса: http://localhost:8765/actuator/health

7. **CRM Service**
   - Запустите класс `CrmServiceApplication` с профилем `dev`
   - Дождитесь регистрации сервиса в Eureka
   - Проверьте статус сервиса: http://localhost:8083/actuator/health
   - **Важно**: CRM-сервис должен запускаться после BRT сервисов

8. **API Gateway**
   - Запустите класс `ApiGatewayApplication` с профилем `dev`
   - Дождитесь регистрации сервиса в Eureka
   - Проверьте, что шлюз перенаправляет запросы: http://localhost:8080/actuator/health

#### Проверка запуска системы

После запуска всех сервисов убедитесь, что:

1. Все сервисы зарегистрированы в Eureka (http://localhost:8761)
2. Все health-endpoints возвращают статус `UP`
3. API Gateway корректно маршрутизирует запросы к сервисам

## Доступ к системе

### Встроенная учетная запись менеджера

При первом запуске системы автоматически создается учетная запись менеджера:

- **MSISDN:** -77777777777
- **Роль:** ROLE_MANAGER

Данная учетная запись создается в SSO-сервисе при его инициализации, если не найдено других учетных записей с ролью MANAGER. Менеджер имеет полный доступ к административным функциям системы, включая:
- Создание новых абонентов
- Управление тарифами абонентов
- Пополнение баланса абонентов

## API Маршруты

API Gateway обеспечивает маршрутизацию к следующим сервисам:

- **SSO Service**: Аутентификация и авторизация
   - `/sso/auth/**` → SSO-service

- **CRM Service**: Управление абонентами
   - `/crm/manager/**` → CRM-service (требует роль MANAGER)
   - `/crm/subscriber/**` → CRM-service (требует роль SUBSCRIBER)

## Бизнес-процессы

### Обработка звонков

1. CDR-сервис генерирует запись о звонке
2. CDR-сервис отправляет пакет CDR в BRT-сервис
3. BRT-сервис проверяет, является ли абонент клиентом оператора "Ромашка"
4. BRT-сервис конвертирует CDR в формат для тарификации и отправляет в HRS
5. HRS-сервис определяет тарифный план абонента и применяет правила тарификации
6. HRS-сервис рассчитывает стоимость звонка с учетом пакетных лимитов
7. HRS-сервис отправляет счет обратно в BRT-сервис
8. BRT-сервис списывает средства с баланса абонента

### Управление тарифами

1. Абонент выбирает тарифный план через API
2. Запрос на смену тарифа поступает в HRS-сервис
3. HRS-сервис назначает выбранный тариф абоненту
4. HRS-сервис инициализирует пакеты услуг и лимиты
5. HRS-сервис выставляет абонентскую плату (если есть)
6. HRS-сервис отправляет счет в BRT-сервис
7. BRT-сервис списывает абонентскую плату с баланса

### Обновление тарифного периода

1. HRS-сервис отслеживает окончание сроков действия тарифов
2. При истечении срока тарифа, HRS-сервис автоматически продлевает его
3. Инициализируются новые пакеты услуг и лимиты
4. Выставляется абонентская плата за следующий период
5. Счет отправляется в BRT-сервис для списания средств

## Тарифные планы

### Классика
- id: 1
- Поминутная тарификация без абонентской платы
- 1.5 у.е. за минуту для звонков внутри сети
- 2.5 у.е. за минуту для звонков на другие сети
- Входящие звонки бесплатны

### Помесячный
- id: 2
- Абонентская плата 100 у.е. в месяц
- 50 минут в пакете бесплатно
- После исчерпания пакета - тарификация по тарифу "Классика"
- Период тарифного плана - 30 дней

## Технический стек

- **Java 17**
- **Spring Boot/Spring Cloud** - фреймворк для разработки
- **Spring Cloud Config** - управление конфигурациями
- **Spring Cloud Netflix Eureka** - сервисное обнаружение
- **PostgreSQL** - основная база данных
- **H2** - in-memory база для CDR-сервиса
- **RabbitMQ** - очередь сообщений
- **Liquibase** - управление миграциями БД
- **Maven** - сборка проекта
- **Docker** - контейнеризация
- **Docker Compose** - оркестрация контейнеров
